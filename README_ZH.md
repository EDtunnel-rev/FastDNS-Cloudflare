# FastDNS-Cloudflare,一个免费的高级DNS解析服务

## 概述

本项目提供了一个高级DNS解析服务，专为在Cloudflare Workers上运行而设计。该服务能够从多个DNS提供商（Cloudflare, Google DNS, OpenDNS）查询DNS记录，通过共识机制选择最可靠的结果，并使用LRU缓存策略缓存结果。此外，服务还包含请求速率限制、详细的日志记录和统计收集，无需依赖KV或Durable Objects等持久存储。

## 功能特性

### 1. 多提供商DNS解析
该服务可以同时查询以下三大DNS提供商：
- **Cloudflare DNS** (1.1.1.1)
- **Google DNS** (8.8.8.8)
- **OpenDNS** (208.67.222.222)

服务会立即返回最快的响应结果以确保低延迟，然后在1秒内等待另外两个响应，并检查结果的一致性。如果发现差异，服务会重新评估并重新查询，最终返回最可靠的结果。

### 2. LRU缓存
实现了一个自定义的内存中LRU缓存，用于存储DNS查询结果。缓存默认最多保存1000个条目，确保最频繁访问的数据能够快速获取，避免重复查询DNS提供商。LRU机制会自动移除最少访问的条目，为新的条目腾出空间。

### 3. 请求速率限制
为防止滥用，服务包含了一个请求速率限制器，每个IP地址每分钟最多可发送60个请求。超出该限制的请求将收到HTTP 429状态（“请求过多”）。

### 4. IP过滤
服务可以基于客户端的IP地址限制访问。默认情况下，它只允许特定的IP范围与服务进行交互。这一设置可以轻松定制以适应不同的安全需求。

### 5. 详细的日志记录与统计
每个请求都会记录详细信息，包括客户端IP地址、查询的DNS名称、记录类型以及返回的结果。此外，还收集了每个DNS提供商的查询统计信息，例如查询次数、成功率、失败率和平均响应时间。这些统计信息可以通过专用的API端点进行访问。

### 6. 可配置的TTL
缓存条目的生存时间（TTL）是可配置的，用户可以控制DNS结果在缓存中保存的时间。默认TTL设置为3600秒（1小时）。

### 7. 错误处理
服务具备健全的错误处理机制。如果某个DNS提供商未能响应或返回错误，服务会优雅地处理错误，最多重试三次查询。如果不同提供商的结果持续不一致，服务会默认选择信任Cloudflare的DNS结果。

## 架构

该DNS解析服务的设计旨在提升性能、可靠性和可扩展性。以下是核心组件的详细介绍：

### LRU缓存
LRU缓存使用双向链表和哈希表结合的设计，实现了插入和查找操作的O(1)时间复杂度。当缓存达到最大容量时，最近最少使用的条目将被移除，为新的条目腾出空间。

### 速率限制器
速率限制器通过滑动时间窗口（默认60秒）跟踪每个IP地址的请求情况。它确保客户端遵守定义的速率限制，防止滥用行为。

### DNS解析和共识机制
服务向三个DNS提供商并发发送DNS查询，最先返回的结果会立即返回给用户以提高速度。然后，服务在1秒内评估其余响应的结果一致性。如果结果不同，服务会再次查询，并根据共识（即至少两家提供商一致）选择最终结果。如果结果持续不一致，服务会选择信任Cloudflare的结果。

### 日志记录与统计
日志和统计信息存储在内存中，并可通过专用端点进行访问。这允许实时监控服务的性能和使用情况。

## 快速开始

### 前提条件

在设置DNS解析服务之前，您需要：
- 一个Cloudflare Workers账户
- JavaScript和HTTP请求的基础知识

### 设置步骤

1. **克隆仓库**

   使用Git将仓库克隆到本地计算机：
   ```bash
   git clone https://github.com/yourusername/dns-resolver-worker.git
   cd dns-resolver-worker
   ```

2. **部署到Cloudflare Workers**

   您需要将服务部署到Cloudflare Workers。这需要设置Cloudflare账户并配置Workers环境。

   ```bash
   wrangler login
   wrangler init
   wrangler publish
   ```

3. **配置环境变量**

   该DNS解析服务不需要KV等持久化存储，但您可以通过环境变量进行配置。在`wrangler.toml`文件中编辑这些变量：

   ```toml
   name = "dns-resolver-worker"
   type = "javascript"

   account_id = "your-account-id"
   workers_dev = true
   compatibility_date = "2023-08-01"
   ```

   您可以在此处添加其他配置，例如自定义TTL、调整缓存大小或设置速率限制。

4. **定制IP过滤和速率限制**

   如需定制IP过滤或速率限制，您可以直接编辑`index.js`文件中的`isAllowedIP`和`RateLimiter`类。根据您的安全需求调整IP范围或请求限制。

### 使用方法

#### 查询DNS记录

您可以通过向您的Cloudflare Worker发送HTTP GET请求来查询DNS记录，并使用以下参数：

- `name`：要查询的域名。
- `type`：DNS记录类型（A, AAAA, CNAME, MX等）。
- `format`：响应格式（json或text）。默认是`json`。
- `ttl`：（可选）缓存条目的生存时间，以秒为单位。

**示例请求：**
```bash
curl "https://your-worker-url.workers.dev?name=example.com&type=A&format=json"
```

**示例响应：**
```json
{
  "Status": 0,
  "TC": false,
  "RD": true,
  "RA": true,
  "AD": false,
  "CD": false,
  "Question": [
    {
      "name": "example.com.",
      "type": 1
    }
  ],
  "Answer": [
    {
      "name": "example.com.",
      "type": 1,
      "TTL": 3599,
      "data": "93.184.216.34"
    }
  ]
}
```

#### 访问统计信息

要查看实时DNS查询统计信息，请访问以下端点：

```bash
curl "https://your-worker-url.workers.dev/stats"
```

这将返回一个JSON对象，包含每个DNS提供商的统计信息，包括查询次数、成功率、失败次数和平均响应时间。

### 修改服务

该服务设计为易于扩展。以下是一些常见的修改示例：

#### 1. 调整缓存大小

如果您需要将缓存大小调整为默认1000条目以外的其他值，请修改`index.js`中的`LRUCache`初始化：

```javascript
const dnsCache = new LRUCache(2000); // 将缓存大小增加到2000条目
```

#### 2. 自定义速率限制

要更改速率限制设置，请修改`RateLimiter`类的初始化：

```javascript
const rateLimiter = new RateLimiter(100, 60000); // 每个IP每分钟允许100个请求
```

#### 3. 添加对更多DNS提供商的支持

您可以通过扩展`fetchDNSFromService`函数，添加对其他DNS提供商的支持。只需添加DNS提供商的查询URL，并更新`Promise.allSettled`调用以包含新的提供商。

#### 4. 使用KV持久化存储

如果您需要缓存或日志的持久化存储，可以修改服务以使用Cloudflare KV。这涉及将缓存和日志机制改为从KV存储中存取数据，而不仅仅依赖于内存中的存储。

### 性能考量

#### 延迟

DNS解析服务通过立即返回第一个可用结果优化了响应延迟。进一步的优化包括使用LRU缓存避免冗余查询，减少对DNS提供商的负载。

#### 吞吐量

鉴于速率限制和缓存机制，服务能够处理大量请求，同时防止滥用，并确保可靠的性能。内存中的存储确保了快速访问，尽管它受制于Workers的执行环境限制。

#### 故障容错

服务的设计考虑了故障容错。如果某个DNS提供商未能响应，服务会优雅地处理错误，重试查询，并最终返回最可靠的结果。通过使用多个DNS提供商和共识机制，服务确保了尽可能高的准确性和可靠性。

### 安全性

#### IP过滤

服务包括IP过滤功能，以基于预定义的IP范围限制访问。这可以根据需要进行修改，以包括或排除特定的IP。IP过滤对于防止未经授权的访问至关

重要，确保只有受信任的客户端能够使用DNS解析服务。

#### 速率限制

速率限制是另一个关键的安全功能，通过限制单个IP地址在特定时间段内可以发出的请求数量来防止滥用。这有助于保护服务免受DDoS攻击，并确保所有客户端的公平使用。

#### HTTPS强制

由于服务部署在Cloudflare Workers上，所有请求默认通过HTTPS处理，确保DNS查询和响应在传输过程中加密。这对于保持DNS查询的完整性和机密性至关重要。

### 故障排除

如果您在使用DNS解析服务时遇到问题，请考虑以下步骤：

#### 检查日志

日志可以提供有关服务操作的宝贵见解，包括可能发生的任何错误。这些日志会打印到控制台，您可以通过Cloudflare Workers仪表板访问它们。

#### 检查速率限制

如果请求被阻止，请确保速率限制设置正确，并且您的IP地址未超过允许的每分钟请求数量。

#### 调试缓存问题

如果服务返回陈旧或意外的结果，请考虑清除缓存或调整TTL设置。可以通过重新部署服务或修改缓存大小来临时使旧条目失效。

#### 监控DNS提供商状态

如果某个DNS提供商持续出现故障，可能是由于提供商本身的问题。考虑暂时禁用有问题的提供商，或调整共识机制以偏向更可靠的提供商。

### 未来增强

虽然服务已经完全功能化，但未来可以实现一些增强功能：

#### 1. 支持更多DNS记录类型
扩展服务以支持更多DNS记录类型，例如SRV, TXT和DNSSEC相关的记录，将增加其灵活性。

#### 2. 与其他Cloudflare服务集成
与其他Cloudflare服务（如Durable Objects或Web Analytics）的集成可以提供额外的洞察力和能力，例如详细的查询日志或持久化存储。

#### 3. 全球负载均衡
实现跨多个Cloudflare数据中心的全球负载均衡，可以通过将DNS查询路由到最近或最快的数据中心进一步提高性能和可靠性。

### 贡献

欢迎对DNS解析服务的贡献！无论是报告错误、提出新功能建议，还是提交拉取请求，您的参与都非常宝贵。请按照以下指南进行贡献：

1. **Fork仓库**

   在GitHub上Fork该仓库，并将其克隆到您的本地计算机。

   ```bash
   git clone https://github.com/yourusername/dns-resolver-worker.git
   ```

2. **创建功能分支**

   为您的功能或Bug修复创建一个新的分支。

   ```bash
   git checkout -b feature/new-feature
   ```

3. **提交更改**

   进行更改，然后用清晰简洁的消息提交它们。

   ```bash
   git commit -m "Add support for SRV records"
   ```

4. **提交拉取请求**

   将更改推送到GitHub并提交拉取请求。包括您所做更改的描述以及它们为什么是必要的。

### 许可

本项目是基于MIT许可证的。详细信息请参阅[LICENSE](LICENSE)文件。

### 致谢

感谢Cloudflare Workers团队提供了一个强大的平台，使创建无服务器应用变得如此容易。
